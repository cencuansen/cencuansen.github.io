<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="author" content="San Huo">


<meta name="subtitle" content="纤凝翠薇巅，扶光入沧渊，扶摇惊砂起，山弄望舒远">




<title>
  San Huo
</title>



<link rel="icon" href="/image/avatar-main.jpeg">




<!-- stylesheets list from _config.yml -->

<link rel="stylesheet" href="/css/style.css">




<!-- scripts list from _config.yml -->

<script src="/js/script.js"></script>

<script src="/js/tocbot.min.js"></script>









<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="San Huo" type="application/atom+xml">
</head>

<body>
  <script>
    // this function is used to check current theme before page loaded.
    (() => {
      const currentTheme = window.localStorage && window.localStorage.getItem('theme') || 'dark';
      const isDark = currentTheme === 'dark';
      const pagebody = document.getElementsByTagName('body')[0]
      const mobileToggleTheme = document.getElementById("mobile-toggle-theme");
      if (isDark) {
        pagebody.classList.add('dark-theme');
        // mobile
        mobileToggleTheme && (document.getElementById("mobile-toggle-theme").innerText = "🌙");
      } else {
        pagebody.classList.remove('dark-theme');
        // mobile
        mobileToggleTheme && (document.getElementById("mobile-toggle-theme").innerText = "☀️");
      }
    })();
  </script>

  <div class="wrapper">
    <header>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-header header-logo"><a href="/">
          首页
        </a></div>
      <div class="menu navbar-right">
        
        <a class="menu-item" href="/categories">
          分类
        </a>
        
        <a class="menu-item" href="/tags">
          标签
        </a>
        
        <input id="switch_default" type="checkbox" checked class="switch_default">
        <label for="switch_default" class="toggleBtn"></label>
      </div>
    </div>
  </nav>

  
  <nav class="navbar-mobile" id="nav-mobile">
    <div class="container">
      <div class="navbar-header">
        <div>
          <a href="/">首页</a>
          <a id="mobile-toggle-theme">☀️</a>
        </div>
        <div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div>
      </div>
      <div class="menu" id="mobile-menu">
        
        <a class="menu-item" href="/categories">分类</a>
        
        <a class="menu-item" href="/tags">标签</a>
        
      </div>
    </div>
  </nav>

</header>
<script>
  var mobileBtn = function f() {
    var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
    var mobileMenu = document.getElementById("mobile-menu");
    if (toggleMenu.classList.contains("active")) {
      toggleMenu.classList.remove("active")
      mobileMenu.classList.remove("active")
    } else {
      toggleMenu.classList.add("active")
      mobileMenu.classList.add("active")
    }
  }
</script>
    <div class="main">
      
<div class="container">
  
  
  <div class="post-toc">
  <div class="tocbot-list"></div>
  <div class="tocbot-list-menu">
    <!-- <a class="tocbot-toc-expand" onclick="expand_toc()">+ 展开</a> -->
    <a onclick="go_top()">↑ 顶部</a>
    <a onclick="go_bottom()">↓ 底部</a>
  </div>
</div>

<script>
  // tocbot: https://github.com/tscanlin/tocbot
  var tocbot_timer;
  var DEPTH_MAX = 6; // 为 6 时展开所有
  var tocbot_default_config = {
    // Where to render the table of contents.
    tocSelector: '.tocbot-list',
    // // Where to grab the headings to build the table of contents.
    contentSelector: '.post-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    // 0: collapse them all; 6: expand all
    collapseDepth: 0,
    orderedList: false,
    scrollSmooth: true,
    isCollapsedClass: 'is-collapsed',
    onClick: () => {} // extend_click,
  };

  function extend_click() {
    clearTimeout(tocbot_timer);
    tocbot_timer = setTimeout(function() {
      tocbot.refresh(obj_merge(tocbot_default_config, {
        hasInnerContainers: false
      }));
    }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
  }

  document.ready(function() {
    tocbot.init(obj_merge(tocbot_default_config));
  });

  function expand_toc() {
    var expandButton = document.querySelector('.tocbot-toc-expand');
    var expanded = expandButton.getAttribute('data-expanded');
    expanded ? expandButton.removeAttribute('data-expanded') : expandButton.setAttribute('data-expanded', true);
    // tocbot.refresh(obj_merge(tocbot_default_config, {
    //   collapseDepth: expanded ? 0 : DEPTH_MAX
    // }));
    expandButton.innerText = expanded ? '+ 展开' : '× 关闭';
  }

  function go_top() {
    window.scrollTo(0, 0);
  }

  function go_bottom() {
    window.scrollTo(0, document.body.scrollHeight);
  }

  function obj_merge(target, source) {
    for (var item in source) {
      if (source.hasOwnProperty(item)) {
        target[item] = source[item];
      }
    }
    return target;
  }
</script>
  

  
  <article class="post-wrap">
    <header class="post-header">
      <h1 class="post-title">
        CSharp 简单应用
      </h1>
      
      <div class="post-meta">
        

        
        <span class="post-time">
          日期：<a href="#">
            2023年 02月
            <!-- &nbsp;&nbsp;23:27:46 -->
          </a>
        </span>
        
        
        <span class="post-category">
          &nbsp;&nbsp;
          分类：
          <a href="/categories/CSharp/">CSharp</a>
          
        </span>
        
      </div>
      
      <section class="post-tags">
        <div style="text-align: left;">
          <span>标签：</span>
          <span class="tag" style>
            
            
            <a href="/tags/CSharp/"># CSharp</a>
            
            
          </span>
        </div>
        <div style="text-align: right; min-width: 50px;">
          <a href="javascript:window.history.back();"> ← 返回</a>
          <!-- <span>&nbsp;|&nbsp;</span>
          <a href="/">返回主页</a> -->
        </div>
      </section>
    </header>

    <div class="post-content">
      <h1 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a>生成二维码</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stream <span class="title">QRCodeStream</span>(<span class="params"><span class="built_in">string</span> contents</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    QRCodeGenerator qrGenerator = <span class="keyword">new</span> QRCodeGenerator();</span><br><span class="line">    QRCodeData qrCodeData = qrGenerator.CreateQrCode(contents, QRCodeGenerator.ECCLevel.L);</span><br><span class="line">    QRCode qrCode = <span class="keyword">new</span> QRCode(qrCodeData);</span><br><span class="line">    Bitmap bigMap = qrCode.GetGraphic(<span class="number">20</span>, Color.Black, Color.White, <span class="literal">true</span>);</span><br><span class="line">    MemoryStream stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">    bigMap.Save(stream, System.Drawing.Imaging.ImageFormat.Png);</span><br><span class="line">    stream.Position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="拼接图片"><a href="#拼接图片" class="headerlink" title="拼接图片"></a>拼接图片</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> file1 = <span class="string">@&quot;C:\Users\Admin\Desktop\images\1.png&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> file2 = <span class="string">@&quot;C:\Users\Admin\Desktop\images\2.png&quot;</span>;</span><br><span class="line">Image image1 = Image.FromStream(<span class="keyword">new</span> MemoryStream(File.ReadAllBytes(file1)));</span><br><span class="line">Image image2 = Image.FromStream(<span class="keyword">new</span> MemoryStream(File.ReadAllBytes(file2)));</span><br><span class="line"><span class="keyword">var</span> image1Width = image1.Width;</span><br><span class="line"><span class="keyword">var</span> image1Height = image1.Height;</span><br><span class="line"><span class="keyword">var</span> image2Width = image2.Height;</span><br><span class="line"><span class="keyword">var</span> image2Height = image2.Height;</span><br><span class="line"><span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"><span class="keyword">using</span> Bitmap map = <span class="keyword">new</span> Bitmap(image1Width, image1Height);<span class="comment">//定义画布</span></span><br><span class="line">Graphics g = Graphics.FromImage(map);<span class="comment">//定义画笔</span></span><br><span class="line">g.Clear(Color.White);<span class="comment">//把画布更改为白色</span></span><br><span class="line">g.DrawImage(image1, <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">g.DrawImage(image2, <span class="keyword">new</span> Point(image1Width - image2Width, image1Height - image2Height));</span><br><span class="line">map.Save(stream, ImageFormat.Jpeg);</span><br></pre></td></tr></table></figure>

<h1 id="端口占用检查"><a href="#端口占用检查" class="headerlink" title="端口占用检查"></a>端口占用检查</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Console.WriteLine(<span class="string">&quot;请输入需要检测的端口号(如：80), 输入exit退出此程序&quot;</span>);</span><br><span class="line">  <span class="keyword">var</span> inPortString = Console.ReadLine();</span><br><span class="line">  Process process = <span class="keyword">new</span> Process();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inPortString == <span class="string">&quot;exit&quot;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    process.Close();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> port = <span class="number">80</span>;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(inPortString))</span><br><span class="line">    &#123;</span><br><span class="line">      Console.WriteLine(<span class="string">&quot;输入端口号非法，将查询默认端口号：80&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      port = Convert.ToInt32(inPortString);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception e)</span><br><span class="line">  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;输入端口号非法，将查询默认端口号：80&quot;</span>);</span><br><span class="line">    port = <span class="number">80</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  process.StartInfo.FileName = <span class="string">&quot;cmd.exe&quot;</span>;</span><br><span class="line">  process.StartInfo.UseShellExecute = <span class="literal">false</span>;</span><br><span class="line">  process.StartInfo.RedirectStandardInput = <span class="literal">true</span>;</span><br><span class="line">  process.StartInfo.RedirectStandardOutput = <span class="literal">true</span>;</span><br><span class="line">  process.StartInfo.RedirectStandardError = <span class="literal">true</span>;</span><br><span class="line">  process.StartInfo.CreateNoWindow = <span class="literal">true</span>;</span><br><span class="line">  process.Start();</span><br><span class="line">  process.StandardInput.WriteLine(<span class="string">&quot;netstat -ano&quot;</span>);</span><br><span class="line">  process.StandardInput.WriteLine(<span class="string">&quot;exit&quot;</span>);</span><br><span class="line">  Regex reg = <span class="keyword">new</span> Regex(<span class="string">&quot;\\s+&quot;</span>, RegexOptions.Compiled);</span><br><span class="line">  <span class="built_in">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">string</span> line = <span class="built_in">string</span>.Empty;</span><br><span class="line">  <span class="keyword">while</span> ((line = process.StandardOutput.ReadLine()) != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    line = line.Trim();</span><br><span class="line">    <span class="keyword">if</span> (line.StartsWith(<span class="string">&quot;TCP&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">    &#123;</span><br><span class="line">      line = reg.Replace(line, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">      <span class="built_in">string</span>[] arr = line.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (arr[<span class="number">1</span>].EndsWith(<span class="string">$&quot;:<span class="subst">&#123;port&#125;</span>&quot;</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        found = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">int</span> pid = <span class="built_in">int</span>.Parse(arr[<span class="number">4</span>]);</span><br><span class="line">        Process foundProcess = Process.GetProcessById(pid);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;port&#125;</span>端口. pid：<span class="subst">&#123;pid&#125;</span>, 进程名：<span class="subst">&#123;foundProcess.ProcessName&#125;</span>\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!found)</span><br><span class="line">  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;未找到<span class="subst">&#123;port&#125;</span>端口上的进程\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  process.Close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="byte-、string、stream-间转换"><a href="#byte-、string、stream-间转换" class="headerlink" title="byte[]、string、stream 间转换"></a>byte[]、string、stream 间转换</h1><h2 id="stream-gt-string"><a href="#stream-gt-string" class="headerlink" title="stream -&gt; string"></a>stream -&gt; string</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> StreamReader reader = <span class="keyword">new</span> StreamReader(stream);</span><br><span class="line"><span class="built_in">string</span> result = reader.ReadToEnd();</span><br></pre></td></tr></table></figure>

<h2 id="string-gt-stream"><a href="#string-gt-stream" class="headerlink" title="string -&gt; stream"></a>string -&gt; stream</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> test = <span class="string">&quot;This is string&quot;</span>;</span><br><span class="line"><span class="keyword">using</span> MemoryStream stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"><span class="keyword">using</span> StreamWriter writer = <span class="keyword">new</span> StreamWriter( stream );</span><br><span class="line">writer.Write( test );</span><br><span class="line">writer.Flush();</span><br></pre></td></tr></table></figure>

<h2 id="byte-gt-string"><a href="#byte-gt-string" class="headerlink" title="byte[] -&gt; string"></a>byte[] -&gt; string</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> str = System.Text.Encoding.Default.GetString( byteArray );</span><br></pre></td></tr></table></figure>

<h2 id="string-gt-byte"><a href="#string-gt-byte" class="headerlink" title="string -&gt; byte[]"></a>string -&gt; byte[]</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[] byteArray = System.Text.Encoding.Default.GetBytes( str );</span><br></pre></td></tr></table></figure>

<h2 id="stream-gt-byte"><a href="#stream-gt-byte" class="headerlink" title="stream -&gt; byte[]"></a>stream -&gt; byte[]</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[stream.Length];</span><br><span class="line">stream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br></pre></td></tr></table></figure>

<h2 id="byte-gt-stream"><a href="#byte-gt-stream" class="headerlink" title="byte[] -&gt; stream"></a>byte[] -&gt; stream</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Stream stream = <span class="keyword">new</span> MemoryStream(bytes);</span><br></pre></td></tr></table></figure>

<h1 id="文本长度"><a href="#文本长度" class="headerlink" title="文本长度"></a>文本长度</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> strTmp = <span class="string">&quot;a1某某某&quot;</span>;</span><br><span class="line"><span class="comment">// 10，Unicode下中英文每个字2字节。</span></span><br><span class="line"><span class="built_in">int</span> len1 = System.Text.Encoding.Unicode.GetBytes(strTmp).Length;</span><br><span class="line"><span class="comment">// 11，Default 等价与 UTF8，中文3个字节，英文1个字节</span></span><br><span class="line"><span class="built_in">int</span> len2 = System.Text.Encoding.Default.GetBytes(strTmp).Length;</span><br><span class="line"><span class="built_in">int</span> len3 = System.Text.Encoding.UTF8.GetBytes(strTmp).Length;</span><br><span class="line"><span class="comment">// 5，就是个数</span></span><br><span class="line"><span class="built_in">int</span> len4 = System.Text.Encoding.Default.GetBytes(strTmp).Length;</span><br></pre></td></tr></table></figure>

<h1 id="WebSocket-应用"><a href="#WebSocket-应用" class="headerlink" title="WebSocket 应用"></a>WebSocket 应用</h1><h2 id="Startup-Configure"><a href="#Startup-Configure" class="headerlink" title="Startup.Configure"></a>Startup.Configure</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.UseWebSockets();</span><br></pre></td></tr></table></figure>

<h2 id="Controller-cs"><a href="#Controller-cs" class="headerlink" title="Controller.cs"></a>Controller.cs</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;receive-message&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">GetMessage</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (HttpContext.WebSockets.IsWebSocketRequest)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> webSocket = <span class="keyword">await</span> HttpContext.WebSockets.AcceptWebSocketAsync())</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;WebSocket connection established&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> Echo(webSocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        HttpContext.Response.StatusCode = <span class="number">400</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">Echo</span>(<span class="params">WebSocket webSocket</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> webSocket.ReceiveAsync(<span class="keyword">new</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;(buffer), CancellationToken.None);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Message received from Client&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (!result.CloseStatus.HasValue)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> serverMsg = Encoding.UTF8.GetBytes(<span class="string">$&quot;Server: Hello. You said: <span class="subst">&#123;Encoding.UTF8.GetString(buffer)&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> webSocket.SendAsync(<span class="keyword">new</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;(serverMsg, <span class="number">0</span>, serverMsg.Length), result.MessageType, result.EndOfMessage, CancellationToken.None);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Message sent to Client&quot;</span>);</span><br><span class="line">        result = <span class="keyword">await</span> webSocket.ReceiveAsync(<span class="keyword">new</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;(buffer), CancellationToken.None);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Message received from Client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> webSocket.CloseAsync(result.CloseStatus.Value, result.CloseStatusDescription, CancellationToken.None);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;WebSocket connection closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var socket = new WebSocket(&#x27;wss://localhost:6666/receive-message&#x27;);</span><br><span class="line">socket.send(&#x27;前端消息&#x27;);</span><br></pre></td></tr></table></figure>

<h1 id="HTTP-网络请求"><a href="#HTTP-网络请求" class="headerlink" title="HTTP 网络请求"></a>HTTP 网络请求</h1><p>HttpWebRequest：最早，不阻塞 ui，细节控制；<br>WebClient：对 HttpWebRequest 的简化和封装；<br>HttpClient：.NET 4.5 开始，预热机制，适合发送多次请求；</p>
<h2 id="HttpClient"><a href="#HttpClient" class="headerlink" title="HttpClient"></a>HttpClient</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> httpClientHandler = <span class="keyword">new</span> HttpClientHandler</span><br><span class="line">&#123;</span><br><span class="line">  Proxy = <span class="keyword">new</span> WebProxy(<span class="string">&quot;http://127.0.0.1:1080&quot;</span>, <span class="literal">false</span>),<span class="comment">// 设置代理</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient(httpClientHandler);</span><br><span class="line"><span class="keyword">var</span> response = <span class="keyword">await</span> httpClient.GetAsync(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> responseText = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br></pre></td></tr></table></figure>

<p>HttpClient 存在 Dispose 后不能立即释放对应套接字问题，默认需要 4 分钟去释放。<br>可以创建一个 HttpClient 实例，把它存储在一个静态字段中，或者使用 HttpClientFactory，<a href="url=https://www.oschina.net/news/77036/httpclient">相关文章</a>。</p>

    </div>

    

    <section class="post-nav">
      
      <a class="prev" rel="prev" href="/2023/02/14/CSharp-dispose/">CSharp dispose</a>
      
      
      <a class="next" rel="next" href="/2023/02/14/CSharp-dotnet-and-csharp/">CSharp .NET 和 C#</a>
      
    </section>
  </article>
</div>
    </div>
    <footer id="footer" class="footer">
    <div class="copyright">
        <span>© San Huo | <a href="https://hexo.io" target="_blank">Hexo</a> & <a
                    href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>
  </div>
</body>

</html>